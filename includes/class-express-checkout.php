<?php
/**
 * PayPal Express Checkout functionality for Website A (Client)
 */

// Exit if accessed directly
if (!defined('ABSPATH')) {
    exit;
}

/**
 * PayPal Express Checkout Class
 */
class WPPPC_Express_Checkout {
    
    private static $buttons_added_to_cart = false;
    private static $buttons_added_to_checkout = false;
    private $current_order_id = null;
    
    /**
     * Constructor
     */
    public function __construct() {
        // Add PayPal buttons to checkout page before customer details
        add_action('woocommerce_before_checkout_form', array($this, 'add_express_checkout_button_to_checkout'), 10);
        
        // Add scripts and styles
        add_action('wp_enqueue_scripts', array($this, 'enqueue_scripts'));
        
        // AJAX handler for creating PayPal order for express checkout
        add_action('wp_ajax_wpppc_create_express_order', array($this, 'ajax_create_express_order'));
        add_action('wp_ajax_nopriv_wpppc_create_express_order', array($this, 'ajax_create_express_order'));
        
        // AJAX handler for completing express order
        add_action('wp_ajax_wpppc_complete_express_order', array($this, 'ajax_complete_express_order'));
        add_action('wp_ajax_nopriv_wpppc_complete_express_order', array($this, 'ajax_complete_express_order'));
        
        // AJAX handler for fetching PayPal order details
        add_action('wp_ajax_wpppc_fetch_paypal_order_details', array($this, 'ajax_fetch_paypal_order_details'));
        add_action('wp_ajax_nopriv_wpppc_fetch_paypal_order_details', array($this, 'ajax_fetch_paypal_order_details'));
    }
    
    /**
     * Check if PayPal gateway is enabled
     * 
     OLD SYSTEM WAS NOT WORKING FOR SOME WEBSITES
     
    private function is_gateway_enabled() {
        // Get the PayPal gateway settings
        $gateway_settings = get_option('woocommerce_paypal_proxy_settings', array());
        
        // Check if enabled
        return isset($gateway_settings['enabled']) && $gateway_settings['enabled'] === 'yes';
    }
    */
    
     /**
     * Check if PayPal gateway is enabled
     */
         private function is_gateway_enabled() {
            // Get all payment gateways
            $payment_gateways = WC()->payment_gateways()->payment_gateways();
            
            // Check if our gateway exists and is enabled
            if (isset($payment_gateways['paypal_proxy'])) {
                $gateway = $payment_gateways['paypal_proxy'];
                
                // First check if the gateway is enabled
                if ($gateway->enabled !== 'yes') {
                    return false;
                }
                
                // If mobile_only is enabled, check if we're on a mobile device
                if ($gateway->get_option('mobile_only') === 'yes' && 
                    method_exists($gateway, 'is_real_mobile_device')) {
                    return $gateway->is_real_mobile_device();
                }
                
                // Gateway is enabled and either mobile_only is off or we're on a mobile device
                return true;
            }
            
            return false;
        }
    
    /**
     * Add Express Checkout button to checkout page
     */
    public function add_express_checkout_button_to_checkout() {
		
        // Check if gateway is enabled - EXIT if disabled
        if (!$this->is_gateway_enabled()) {
            return;
        }
        
        if (self::$buttons_added_to_checkout) {
            return;
        }
        self::$buttons_added_to_checkout = true;
        
        // Only show if we have a server
        $server_manager = WPPPC_Server_Manager::get_instance();
        $server = $server_manager->get_selected_server();
        
        if (!$server) {
            $server = $server_manager->get_next_available_server();
        }
        
        if (!$server) {
            wpppc_log("Express Checkout: No PayPal server available for checkout buttons");
            return;
        }
        
        //Check if server is in Personal mode, if so don't show Express Checkout
        if (!empty($server->is_personal)) {
            return;
        }
		
		//Check if express is turned on
		if (!empty(!$server->checkout_express)) {
            return;
        }
        
      echo '<div class="wpppc-express-checkout-container">';
        echo '<div class="express-label-top"><span>' . __('Express Checkout', 'woo-paypal-proxy-client') . '</span></div>';
        echo '<div id="wpppc-express-paypal-button-checkout" class="wpppc-express-paypal-button"></div>';
        echo '<div class="wpppc-express-separator"><span>' . __('OR Continue Below', 'woo-paypal-proxy-client') . '</span></div>';
		echo '</div>';

        
    }
    
    /**
     * Enqueue scripts and styles for Express Checkout
     */
    public function enqueue_scripts() {
        // Check if gateway is enabled - EXIT if disabled
        if (!$this->is_gateway_enabled()) {
            return;
        }
        
        if (!is_cart() && !is_checkout()) {
            return;
        }
		
		 // Get server for button URL
        $server_manager = WPPPC_Server_Manager::get_instance();
        $server = $server_manager->get_selected_server();
        
        if (!$server) {
            $server = $server_manager->get_next_available_server();
        }
        
        if (!$server) {
            return;
        }
		
		if (!empty(!$server->checkout_express)) {
            return;
        }
        
        // Enqueue custom express checkout styles
        wp_enqueue_style('wpppc-express-checkout', WPPPC_PLUGIN_URL . 'assets/css/express-checkout.css', array(), WPPPC_VERSION);
        
        // Enqueue custom script for Express Checkout
        wp_enqueue_script('wpppc-express-checkout', WPPPC_PLUGIN_URL . 'assets/js/express-checkout.js', array('jquery'), time(), true);
      
        // Get API handler with server
        $api_handler = new WPPPC_API_Handler();
        
        // Create base button iframe URL (will be updated with current totals when clicked)
        $iframe_url = $api_handler->generate_express_iframe_url();
        
        // Pass data to JavaScript
        wp_localize_script('wpppc-express-checkout', 'wpppc_express_params', array(
            'ajax_url' => admin_url('admin-ajax.php'),
            'nonce' => wp_create_nonce('wpppc-express-nonce'),
            'iframe_url' => $iframe_url,
            'cart_total' => WC()->cart->get_total(''),
            'currency' => get_woocommerce_currency(),
            'shipping_required' => WC()->cart->needs_shipping(),
            'is_checkout_page' => is_checkout(),
            'is_cart_page' => is_cart(),
            'debug_mode' => true
        ));
    }
    
/**
 * AJAX handler for creating a PayPal order for Express Checkout
 */
public function ajax_create_express_order() {
    //check_ajax_referer('wpppc-express-nonce', 'nonce');
    
    wpppc_log("Express Checkout: Creating order via AJAX");
    
    try {
        // Get current checkout totals
        $current_totals = isset($_POST['current_totals']) ? $_POST['current_totals'] : array();
        
        $session = WC()->session;
        
        
        // Check for existing express checkout order in session
$existing_order_id = $session->get('express_checkout_order_id');
if ($existing_order_id) {
    $existing_order = wc_get_order($existing_order_id);
    if ($existing_order && $existing_order->get_status() === 'pending') {
        // Get existing PayPal order ID
        $existing_paypal_order_id = get_post_meta($existing_order_id, '_paypal_order_id', true);
        $existing_approve_url = $session->get('express_checkout_paypal_approve_url');
        
        if ($existing_paypal_order_id) {
            // Check if amounts match
            $current_total = isset($current_totals['total']) ? floatval($current_totals['total']) : 0;
            $existing_total = floatval($existing_order->get_total());
            
            if (abs($current_total - $existing_total) < 0.01) {
                // Amounts match, return existing order
                wpppc_log("Express Checkout: Returning existing order #{$existing_order_id} with matching total: $current_total");
                
                wp_send_json_success(array(
                    'order_id' => $existing_order_id,
                    'paypal_order_id' => $existing_paypal_order_id,
                    'approveUrl' => $existing_approve_url
                ));
                wp_die();
            }  else {
    // Amounts don't match, need to create new PayPal order
    wpppc_log("Express Checkout: Order totals changed - Old: $existing_total, New: $current_total. Creating new PayPal order.");
    
    // Clear the existing PayPal order data since we'll create a new one
    delete_post_meta($existing_order_id, '_paypal_order_id');
    $session->set('express_checkout_paypal_order_id', '');
    $session->set('express_checkout_paypal_approve_url', '');
    
    // CLEAR ALL EXISTING ORDER ITEMS FIRST
    foreach ($existing_order->get_items() as $item_id => $item) {
        $existing_order->remove_item($item_id);
    }
    foreach ($existing_order->get_items('fee') as $item_id => $item) {
        $existing_order->remove_item($item_id);
    }
    foreach ($existing_order->get_items('coupon') as $item_id => $item) {
        $existing_order->remove_item($item_id);
    }
    foreach ($existing_order->get_items('shipping') as $item_id => $item) {
        $existing_order->remove_item($item_id);
    }
    
    // UPDATE CURRENCY IF CHANGED
    global $WOOCS;
    $current_currency = $WOOCS->current_currency;
    if ($existing_order->get_currency() !== $current_currency) {
        $existing_order->set_currency($current_currency);
        $existing_order->save();
        wpppc_log("Express Checkout: Updated order currency from {$existing_order->get_currency()} to {$current_currency}");
    }
    // UPDATE CHECKOUT TOTALS METADATA
    if (!empty($current_totals)) {
        update_post_meta($existing_order->get_id(), '_express_checkout_totals', $current_totals);
    }
    
    // NOW ADD CURRENT CART ITEMS TO ORDER
    foreach (WC()->cart->get_cart() as $cart_item_key => $cart_item) {
        $product = $cart_item['data'];
        $variation_id = !empty($cart_item['variation_id']) ? $cart_item['variation_id'] : 0;
        
        // Add line item
        $item = new WC_Order_Item_Product();
        $item->set_props(array(
            'product_id'   => $product->get_id(),
            'variation_id' => $variation_id,
            'quantity'     => $cart_item['quantity'],
            'subtotal'     => $cart_item['line_subtotal'],
            'total'        => $cart_item['line_total'],
            'subtotal_tax' => $cart_item['line_subtotal_tax'],
            'total_tax'    => $cart_item['line_tax'],
            'taxes'        => $cart_item['line_tax_data']
        ));
        
        $item->set_name($product->get_name());
        
        // Add variation data
        if (!empty($cart_item['variation'])) {
            foreach ($cart_item['variation'] as $meta_name => $meta_value) {
                $item->add_meta_data(str_replace('attribute_', '', $meta_name), $meta_value);
            }
        }
        
        // CRITICAL: Run the WooCommerce hook that WAPF and other plugins use
        do_action('woocommerce_checkout_create_order_line_item', $item, $cart_item_key, $cart_item, $existing_order);
        
        $existing_order->add_item($item);
    }
    
    // ADD CURRENT FEES
    foreach (WC()->cart->get_fees() as $fee) {
        $fee_item = new WC_Order_Item_Fee();
        $fee_item->set_props(array(
            'name'      => $fee->name,
            'tax_class' => $fee->tax_class,
            'total'     => $fee->amount,
            'total_tax' => $fee->tax,
            'taxes'     => array(
                'total' => $fee->tax_data,
            ),
        ));
        $existing_order->add_item($fee_item);
    }
    
    // ADD CURRENT COUPONS
    foreach (WC()->cart->get_coupons() as $code => $coupon) {
        $coupon_item = new WC_Order_Item_Coupon();
        $coupon_item->set_props(array(
            'code'         => $code,
            'discount'     => WC()->cart->get_coupon_discount_amount($code),
            'discount_tax' => WC()->cart->get_coupon_discount_tax_amount($code),
        ));
        
        if (method_exists($coupon_item, 'add_meta_data')) {
            $coupon_item->add_meta_data('coupon_data', $coupon->get_data());
        }
        
        $existing_order->add_item($coupon_item);
    }
    
    // ADD CURRENT SHIPPING METHOD
    if (!empty($current_totals['shipping_method'])) {
        $shipping_method_id = $current_totals['shipping_method'];
        $shipping_method_found = false;
        
        // Use label from frontend if provided
        $method_title = !empty($current_totals['shipping_method_label']) 
            ? $current_totals['shipping_method_label'] 
            : '';
        
        wpppc_log("Express Checkout: Adding shipping method ID: " . $shipping_method_id);
        
        // Get actual shipping method details
        foreach (WC()->shipping->get_packages() as $package_key => $package) {
            if (isset($package['rates'][$shipping_method_id])) {
                $shipping_rate = $package['rates'][$shipping_method_id];
                
                // If no label from frontend, use the one from the rate
                if (empty($method_title)) {
                    $method_title = $shipping_rate->get_label();
                }
                
                $item = new WC_Order_Item_Shipping();
                $item->set_props(array(
                    'method_title' => $method_title,
                    'method_id'    => $shipping_rate->get_method_id(),
                    'instance_id'  => $shipping_rate->get_instance_id(),
                    'total'        => $current_totals['shipping'],
                    'taxes'        => array(),
                ));
                
                foreach ($shipping_rate->get_meta_data() as $key => $value) {
                    $item->add_meta_data($key, $value, true);
                }
                
                $existing_order->add_item($item);
                $shipping_method_found = true;
                
                wpppc_log("Express Checkout: Added shipping method: " . $method_title);
                break;
            }
        }
        
        // Fallback if method not found
        if (!$shipping_method_found) {
            // Try to extract method ID and instance ID
            $method_parts = explode(':', $shipping_method_id);
            $method_id = $method_parts[0];
            $instance_id = isset($method_parts[1]) ? $method_parts[1] : '';
            
            // Use label from frontend if provided, otherwise get method name
            if (empty($method_title)) {
                $all_methods = WC()->shipping->get_shipping_methods();
                if (isset($all_methods[$method_id])) {
                    $method_title = $all_methods[$method_id]->get_method_title();
                } else {
                    $method_title = 'Shipping';
                }
            }
            
            $item = new WC_Order_Item_Shipping();
            $item->set_props(array(
                'method_title' => $method_title,
                'method_id'    => $method_id,
                'instance_id'  => $instance_id,
                'total'        => $current_totals['shipping'],
                'taxes'        => array(),
            ));
            $existing_order->add_item($item);
            
            wpppc_log("Express Checkout: Added fallback shipping method: " . $method_title);
        }
    } else if (!empty($current_totals['shipping']) && floatval($current_totals['shipping']) > 0) {
        // We have shipping cost but no method
        $method_title = !empty($current_totals['shipping_method_label']) 
            ? $current_totals['shipping_method_label'] 
            : 'Shipping';
        
        wpppc_log("Express Checkout: No shipping method ID but shipping cost exists: " . $current_totals['shipping']);
        
        // Get available shipping methods
        $available_methods = array();
        foreach (WC()->shipping->get_packages() as $package_key => $package) {
            if (!empty($package['rates'])) {
                $available_methods = $package['rates'];
                break;
            }
        }
        
        // If only one method is available, use that
        if (count($available_methods) === 1) {
            $only_method = reset($available_methods);
            // If no label from frontend, use the one from the method
            if ($method_title === 'Shipping') {
                $method_title = $only_method->get_label();
            }
            
            $item = new WC_Order_Item_Shipping();
            $item->set_props(array(
                'method_title' => $method_title,
                'method_id'    => $only_method->get_method_id(),
                'instance_id'  => $only_method->get_instance_id(),
                'total'        => $current_totals['shipping'],
                'taxes'        => array(),
            ));
            $existing_order->add_item($item);
            wpppc_log("Express Checkout: Added single available shipping method: " . $method_title);
        } else {
            // No specific method found, use generic with label
            $item = new WC_Order_Item_Shipping();
            $item->set_props(array(
                'method_title' => $method_title,
                'method_id'    => 'flat_rate',
                'total'        => $current_totals['shipping'],
                'taxes'        => array(),
            ));
            $existing_order->add_item($item);
            wpppc_log("Express Checkout: Added generic shipping with title: " . $method_title);
        }
    }
    
    // Update the order with new totals
    $existing_order->set_total($current_total);
    if (isset($current_totals['shipping'])) {
        $existing_order->set_shipping_total($current_totals['shipping']);
    }
    if (isset($current_totals['tax'])) {
        $existing_order->set_cart_tax($current_totals['tax']);
    }
    
    // Run important WooCommerce hooks
    do_action('woocommerce_checkout_create_order', $existing_order, array());
    do_action('woocommerce_checkout_update_order_meta', $existing_order->get_id(), array());
    
    $existing_order->save();
    
    // Use the updated existing order
    $order = $existing_order;
    $skip_order_creation = true;
    
    wpppc_log("Express Checkout: Updated existing order #{$existing_order->get_id()} with new cart contents and totals");
}
        }
    }
}
        
        if (!isset($skip_order_creation)) {
            $order = wc_create_order();
            
            // Mark as express checkout
            $order->add_meta_data('_wpppc_express_checkout', 'yes');
            
            update_post_meta($order->get_id(), '_wpppc_funding_source', 'Express');
            
            // STORE the checkout totals FIRST
            if (!empty($current_totals)) {
                update_post_meta($order->get_id(), '_express_checkout_totals', $current_totals);
            }
            $session->set('express_checkout_order_id', $order->get_id());
        
        
// Add cart items to order
foreach (WC()->cart->get_cart() as $cart_item_key => $cart_item) {
    $product = $cart_item['data'];
    $variation_id = !empty($cart_item['variation_id']) ? $cart_item['variation_id'] : 0;
    
    // Add line item
    $item = new WC_Order_Item_Product();
    $item->set_props(array(
        'product_id'   => $product->get_id(),
        'variation_id' => $variation_id,
        'quantity'     => $cart_item['quantity'],
        'subtotal'     => $cart_item['line_subtotal'],
        'total'        => $cart_item['line_total'],
        'subtotal_tax' => $cart_item['line_subtotal_tax'],
        'total_tax'    => $cart_item['line_tax'],
        'taxes'        => $cart_item['line_tax_data']
    ));
    
    $item->set_name($product->get_name());
    
    // Add variation data
    if (!empty($cart_item['variation'])) {
        foreach ($cart_item['variation'] as $meta_name => $meta_value) {
            $item->add_meta_data(str_replace('attribute_', '', $meta_name), $meta_value);
        }
    }
    
    // CRITICAL: Run the WooCommerce hook that WAPF and other plugins use
    do_action('woocommerce_checkout_create_order_line_item', $item, $cart_item_key, $cart_item, $order);
    
    $order->add_item($item);
}

// Run the hook that WAPF might use after all items are added
do_action('woocommerce_checkout_create_order', $order, array());

// Trigger the order meta hook that some plugins use
do_action('woocommerce_checkout_update_order_meta', $order->get_id(), array());
        
        // Add fees
        foreach (WC()->cart->get_fees() as $fee) {
            $fee_item = new WC_Order_Item_Fee();
            $fee_item->set_props(array(
                'name'      => $fee->name,
                'tax_class' => $fee->tax_class,
                'total'     => $fee->amount,
                'total_tax' => $fee->tax,
                'taxes'     => array(
                    'total' => $fee->tax_data,
                ),
            ));
            $order->add_item($fee_item);
        }
        
        // Add coupons
        foreach (WC()->cart->get_coupons() as $code => $coupon) {
            $coupon_item = new WC_Order_Item_Coupon();
            $coupon_item->set_props(array(
                'code'         => $code,
                'discount'     => WC()->cart->get_coupon_discount_amount($code),
                'discount_tax' => WC()->cart->get_coupon_discount_tax_amount($code),
            ));
            
            if (method_exists($coupon_item, 'add_meta_data')) {
                $coupon_item->add_meta_data('coupon_data', $coupon->get_data());
            }
            
            $order->add_item($coupon_item);
        }
        
// Set payment method
$order->set_payment_method('paypal_proxy');

// Add shipping method
if (!empty($current_totals['shipping_method'])) {
    $shipping_method_id = $current_totals['shipping_method'];
    $shipping_method_found = false;
    
    // Use label from frontend if provided
    $method_title = !empty($current_totals['shipping_method_label']) 
        ? $current_totals['shipping_method_label'] 
        : '';
    
    wpppc_log("Express Checkout: Using shipping method ID: " . $shipping_method_id);
    wpppc_log("Express Checkout: Using shipping method label: " . $method_title);
    
    // Get actual shipping method details
    foreach (WC()->shipping->get_packages() as $package_key => $package) {
        if (isset($package['rates'][$shipping_method_id])) {
            $shipping_rate = $package['rates'][$shipping_method_id];
            
            // If no label from frontend, use the one from the rate
            if (empty($method_title)) {
                $method_title = $shipping_rate->get_label();
            }
            
            $item = new WC_Order_Item_Shipping();
            $item->set_props(array(
                'method_title' => $method_title,
                'method_id'    => $shipping_rate->get_method_id(),
                'instance_id'  => $shipping_rate->get_instance_id(),
                'total'        => $current_totals['shipping'],
                'taxes'        => array(),
            ));
            
            foreach ($shipping_rate->get_meta_data() as $key => $value) {
                $item->add_meta_data($key, $value, true);
            }
            
            $order->add_item($item);
            $shipping_method_found = true;
            
            wpppc_log("Express Checkout: Added shipping method: " . $method_title);
            break;
        }
    }
    
    // Fallback if method not found
    if (!$shipping_method_found) {
        // Try to extract method ID and instance ID
        $method_parts = explode(':', $shipping_method_id);
        $method_id = $method_parts[0];
        $instance_id = isset($method_parts[1]) ? $method_parts[1] : '';
        
        // Use label from frontend if provided, otherwise get method name
        if (empty($method_title)) {
            $all_methods = WC()->shipping->get_shipping_methods();
            if (isset($all_methods[$method_id])) {
                $method_title = $all_methods[$method_id]->get_method_title();
            } else {
                $method_title = 'Shipping';
            }
        }
        
        $item = new WC_Order_Item_Shipping();
        $item->set_props(array(
            'method_title' => $method_title,
            'method_id'    => $method_id,
            'instance_id'  => $instance_id,
            'total'        => $current_totals['shipping'],
            'taxes'        => array(),
        ));
        $order->add_item($item);
        
        wpppc_log("Express Checkout: Added fallback shipping method: " . $method_title);
    }
} else if (!empty($current_totals['shipping']) && floatval($current_totals['shipping']) > 0) {
    // We have shipping cost but no method
    $method_title = !empty($current_totals['shipping_method_label']) 
        ? $current_totals['shipping_method_label'] 
        : 'Shipping';
    
    wpppc_log("Express Checkout: No shipping method ID but shipping cost exists: " . $current_totals['shipping']);
    
    // Get available shipping methods
    $available_methods = array();
    foreach (WC()->shipping->get_packages() as $package_key => $package) {
        if (!empty($package['rates'])) {
            $available_methods = $package['rates'];
            break;
        }
    }
    
    // If only one method is available, use that
    if (count($available_methods) === 1) {
        $only_method = reset($available_methods);
        // If no label from frontend, use the one from the method
        if ($method_title === 'Shipping') {
            $method_title = $only_method->get_label();
        }
        
        $item = new WC_Order_Item_Shipping();
        $item->set_props(array(
            'method_title' => $method_title,
            'method_id'    => $only_method->get_method_id(),
            'instance_id'  => $only_method->get_instance_id(),
            'total'        => $current_totals['shipping'],
            'taxes'        => array(),
        ));
        $order->add_item($item);
        wpppc_log("Express Checkout: Added single available shipping method: " . $method_title);
    } else {
        // No specific method found, use generic with label
        $item = new WC_Order_Item_Shipping();
        $item->set_props(array(
            'method_title' => $method_title,
            'method_id'    => 'flat_rate',
            'total'        => $current_totals['shipping'],
            'taxes'        => array(),
        ));
        $order->add_item($item);
        wpppc_log("Express Checkout: Added generic shipping with title: " . $method_title);
    }
}

// Set initial addresses as empty
$order->set_address(array(), 'billing');
$order->set_address(array(), 'shipping');

// CRITICAL: Disable tax calculation for this order
add_filter('woocommerce_order_get_tax_location', function($location, $tax_class, $customer) use ($order) {
    if ($order->get_id() === $this->current_order_id) {
        // Return invalid location to prevent tax calculation
        return array('', '', '', '');
    }
    return $location;
}, 10, 3);

// Store current order ID for filter
$this->current_order_id = $order->get_id();

// Remove all tax items before calculating
foreach ($order->get_items('tax') as $item_id => $item) {
    $order->remove_item($item_id);
}

// Force zero tax
$order->set_cart_tax(0);
$order->set_shipping_tax(0);

// Calculate totals WITHOUT tax calculation
$order->calculate_totals(false);

// Force exact totals after calculation
$order->set_total($current_totals['total']);
$order->set_shipping_total($current_totals['shipping']);
$order->set_discount_total($order->get_total_discount());

// Ensure tax stays at zero
if (floatval($current_totals['tax']) === 0) {
    $order->set_cart_tax(0);
    $order->set_shipping_tax(0);
    update_post_meta($order->get_id(), '_order_tax', 0);
    update_post_meta($order->get_id(), '_cart_tax', 0);
    update_post_meta($order->get_id(), '_shipping_tax', 0);
}

// Mark to prevent future recalculation
$order->update_meta_data('_wpppc_tax_adjusted', 'yes');
$order->add_meta_data('_wpppc_express_checkout', 'yes');
// Set order status
$order->update_status('pending', __('Order created via PayPal Express Checkout', 'woo-paypal-proxy-client'));

// Save the order
$order->save();
}
// Clean up
$this->current_order_id = null;

wpppc_log("Express Checkout: Order #" . $order->get_id() . " created with:" .
          " Total: " . $order->get_total() .
          ", Shipping: " . $order->get_shipping_total() .
          ", Tax: " . $order->get_total_tax());
          
          
        // Use current totals from checkout page
        $order_total = isset($current_totals['total']) ? $current_totals['total'] : $order->get_total();
        $order_subtotal = isset($current_totals['subtotal']) ? $current_totals['subtotal'] : $order->get_subtotal();
        $shipping_total = isset($current_totals['shipping']) ? $current_totals['shipping'] : $order->get_shipping_total();
        $tax_total = isset($current_totals['tax']) ? $current_totals['tax'] : $order->get_total_tax();
        
        wpppc_log("Express Checkout: Using totals from checkout - Total: $order_total, Subtotal: $order_subtotal, Shipping: $shipping_total, Tax: $tax_total");
        
        // Get server to use
        $server_manager = WPPPC_Server_Manager::get_instance();
        $server = $server_manager->get_selected_server();
        
        if (!$server) {
            $server = $server_manager->get_next_available_server();
        }
        
        if (!$server) {
            throw new Exception(__('No PayPal server available', 'woo-paypal-proxy-client'));
        }
        
        // Store server ID in order
        update_post_meta($order->get_id(), '_wpppc_server_id', $server->id);
        
        // Prepare line items for PayPal with detailed information
        $line_items = array();
        
        foreach ($order->get_items() as $item) {
            $product = $item->get_product();
            
            if (!$product) continue;
            
            $line_items[] = array(
                'name' => $item->get_name(),
                'quantity' => $item->get_quantity(),
                'unit_price' => $order->get_item_subtotal($item, false),
                'tax_amount' => $item->get_total_tax(),
                'sku' => $product ? $product->get_sku() : '',
                'product_id' => $product ? $product->get_id() : 0,
                'description' => $product ? wp_trim_words($product->get_short_description(), 15) : ('Product ID: ' . $product->get_id())
            );
        }
        
        // Apply product mapping to line items
        if (function_exists('add_product_mappings_to_items')) {
            $line_items = add_product_mappings_to_items($line_items, $server->id);
            wpppc_log("Express Checkout: Product mapping applied to line items");
        }
        
        // Get customer information if available
        $customer_info = array();
        if (is_user_logged_in()) {
            $current_user = wp_get_current_user();
            $customer_info = array(
                'first_name' => $current_user->first_name,
                'last_name' => $current_user->last_name,
                'email' => $current_user->user_email
            );
        }
        
        // Create order data for proxy server with EXACT checkout totals
        $order_data = array(
            'order_id' => $order->get_id(),
            'order_key' => $order->get_order_key(),
            'line_items' => $line_items,
            'cart_total' => $order_subtotal,
            'order_total' => $order_total,
            'tax_total' => $tax_total,
            'shipping_total' => $shipping_total,
            'discount_total' => $order->get_discount_total(),
            'currency' => $order->get_currency(),
            'return_url' => wc_get_checkout_url(),
            'cancel_url' => wc_get_cart_url(),
            'callback_url' => WC()->api_request_url('wpppc_shipping'),
            'needs_shipping' => WC()->cart->needs_shipping(),
            'server_id' => $server->id,
            'customer_info' => $customer_info
        );
        
        // Encode the order data to base64
        $order_data_encoded = base64_encode(json_encode($order_data));
        
        // Generate security hash with the EXACT total
        $timestamp = time();
        $hash_data = $timestamp . $order->get_id() . $order_total . $server->api_key;
        $hash = hash_hmac('sha256', $hash_data, $server->api_secret);
        
        // Create request data with proper format for proxy server
        $request_data = array(
            'api_key' => $server->api_key,
            'timestamp' => $timestamp,
            'hash' => $hash,
            'order_data' => $order_data_encoded
        );
        
        wpppc_log("Express Checkout: Sending properly formatted request to proxy server");
        
        // Send request to proxy server
        $response = wp_remote_post(
            $server->url . '/wp-json/wppps/v1/create-express-checkout',
            array(
                'timeout' => 30,
                'headers' => array('Content-Type' => 'application/json'),
                'body' => json_encode($request_data)
            )
        );
        
        // Check for errors
        if (is_wp_error($response)) {
            wpppc_log("Express Checkout: Error communicating with proxy server: " . $response->get_error_message());
            throw new Exception(__('Error communicating with proxy server: ', 'woo-paypal-proxy-client') . $response->get_error_message());
        }
        
        // Get response code
        $response_code = wp_remote_retrieve_response_code($response);
        if ($response_code !== 200) {
            wpppc_log("Express Checkout: Proxy server returned error code: $response_code");
            wpppc_log("Express Checkout: Response body: " . wp_remote_retrieve_body($response));
            throw new Exception(__('Proxy server returned error', 'woo-paypal-proxy-client'));
        }
        
        // Parse response
        $body = json_decode(wp_remote_retrieve_body($response), true);
        
        if (!$body || !isset($body['success']) || $body['success'] !== true) {
            $error_message = isset($body['message']) ? $body['message'] : __('Unknown error from proxy server', 'woo-paypal-proxy-client');
            wpppc_log("Express Checkout: Proxy server error: $error_message");
            throw new Exception($error_message);
        }
        
        // Store PayPal order ID in WooCommerce order
        $paypal_order_id = isset($body['paypal_order_id']) ? $body['paypal_order_id'] : '';
        if (!empty($paypal_order_id)) {
            // Store the ppl order ID in the session before proceeding
            $session->set('express_checkout_paypal_order_id', $paypal_order_id);
            
            $session->set('express_checkout_paypal_approve_url', isset($body['approve_url']) ? $body['approve_url'] : '');
            
            update_post_meta($order->get_id(), '_paypal_order_id', $paypal_order_id);
            wpppc_log("Express Checkout: Stored PayPal order ID: $paypal_order_id for order #{$order->get_id()}");
        } else {
            wpppc_log("Express Checkout: No PayPal order ID received from proxy server");
            throw new Exception(__('No PayPal order ID received from proxy server', 'woo-paypal-proxy-client'));
        }
        
        // Return success with PayPal order ID
        wp_send_json_success(array(
            'order_id' => $order->get_id(),
            'paypal_order_id' => $paypal_order_id,
            'approveUrl' => isset($body['approve_url']) ? $body['approve_url'] : ''
        ));
        
    } catch (Exception $e) {
        wpppc_log("Express Checkout: Error creating order: " . $e->getMessage());
        wp_send_json_error(array(
            'message' => $e->getMessage()
        ));
    }
    
    wp_die();
}
    
public function ajax_complete_express_order() {
    //check_ajax_referer('wpppc-express-nonce', 'nonce');
    
    $order_id = isset($_POST['order_id']) ? intval($_POST['order_id']) : 0;
    $paypal_order_id = isset($_POST['paypal_order_id']) ? sanitize_text_field($_POST['paypal_order_id']) : '';
    
    try {
        // Get order
        $order = wc_get_order($order_id);
        if (!$order) {
            throw new Exception(__('Order not found', 'woo-paypal-proxy-client'));
        }
        
        // Check if we already have addresses from the fetch operation
        $has_shipping_address = !empty($order->get_shipping_address_1());
        $has_billing_address = !empty($order->get_billing_address_1());
        
        wpppc_log("DEBUG: Order has shipping address: " . ($has_shipping_address ? 'Yes' : 'No'));
        wpppc_log("DEBUG: Order has billing address: " . ($has_billing_address ? 'Yes' : 'No'));
        
        // RESTORE the original checkout totals
        $stored_totals = get_post_meta($order->get_id(), '_express_checkout_totals', true);
        
        if (!empty($stored_totals)) {
            // Set individual amounts
            if (isset($stored_totals['shipping'])) {
                $order->set_shipping_total($stored_totals['shipping']);
            }
            
            if (isset($stored_totals['tax'])) {
                // Use the proper method to set cart tax
                $order->set_cart_tax($stored_totals['tax']);
                
                // Set meta for tax amounts
                update_post_meta($order->get_id(), '_order_tax', $stored_totals['tax']);
                update_post_meta($order->get_id(), '_cart_tax', $stored_totals['tax']);
                
                // Create tax items if they don't exist
                $tax_items = $order->get_items('tax');
                if (empty($tax_items) && $stored_totals['tax'] > 0) {
                    $item = new WC_Order_Item_Tax();
                    $item->set_props(array(
                        'rate_id' => 0,
                        'label' => 'Tax',
                        'compound' => false,
                        'tax_total' => $stored_totals['tax'],
                        'shipping_tax_total' => 0,
                    ));
                    $order->add_item($item);
                }
            }
            
            // Ensure shipping method is properly set
            if (!empty($stored_totals['shipping_method'])) {
                $shipping_items = $order->get_items('shipping');
                if (empty($shipping_items)) {
                    // Add shipping method if missing
                    $item = new WC_Order_Item_Shipping();
                    $item->set_method_id('flat_rate');
                    $item->set_method_title('Shipping');
                    $item->set_total($stored_totals['shipping']);
                    $order->add_item($item);
                }
            }
            
            // Force the order total to use our exact values
            $order->set_total($stored_totals['total']);
            
            // Mark order as having adjusted totals
            $order->update_meta_data('_wpppc_tax_adjusted', 'yes');
            
            // IMPORTANT: Save the order to preserve the addresses
            $order->save();
        }
            
        
        // Get server ID
        $server_id = get_post_meta($order->get_id(), '_wpppc_server_id', true);
        
        // Get server
        $server_manager = WPPPC_Server_Manager::get_instance();
        $server = $server_manager->get_server($server_id);
        
        if (!$server) {
            throw new Exception(__('PayPal server not found', 'woo-paypal-proxy-client'));
        }
        
        // Capture payment
        $api_handler = new WPPPC_API_Handler($server_id);
        
        // Prepare request data with BOTH order ID and PayPal order ID
        $request_data = array(
            'order_id' => $order_id,
            'paypal_order_id' => $paypal_order_id,
            'order_total' => $order->get_total(),
            'currency' => $order->get_currency(),
            'server_id' => $server_id
        );
        
        // Generate security hash
        $timestamp = time();
        $hash_data = $timestamp . $order_id . $paypal_order_id . $server->api_key;
        $hash = hash_hmac('sha256', $hash_data, $server->api_secret);
        
        $response = wp_remote_post(
            $server->url . '/wp-json/wppps/v1/capture-express-payment',
            array(
                'timeout' => 30,
                'headers' => array('Content-Type' => 'application/json'),
                'body' => json_encode(array(
                    'api_key' => $server->api_key,
                    'hash' => $hash,
                    'timestamp' => $timestamp,
                    'request_data' => base64_encode(json_encode($request_data))
                ))
            )
        );
        
        // Check response
        if (is_wp_error($response)) {
            throw new Exception($response->get_error_message());
        }
        
        $body = json_decode(wp_remote_retrieve_body($response), true);
        
        if (!$body || !isset($body['success']) || $body['success'] !== true) {
            throw new Exception(isset($body['message']) ? $body['message'] : 'Unknown error');
        }
        
        // Get transaction ID
        $transaction_id = isset($body['transaction_id']) ? $body['transaction_id'] : '';
        $seller_protection = isset($body['seller_protection']) ? $body['seller_protection'] : 'UNKNOWN';
        
        //paypal account verified or not
        $acc_verified_status = isset($body['account_status']) ? $body['account_status'] : 'UNKNOWN';
        
        // NOW properly complete the payment
        if (!empty($transaction_id)) {
            // Use payment_complete() to properly mark order as paid
            $order->payment_complete($transaction_id);
            
            // Add detailed note
            $order->add_order_note(sprintf(
                __('Payment completed via PayPal Express Checkout. Transaction ID: %s, PayPal Order ID: %s', 'woo-paypal-proxy-client'),
                $transaction_id,
                $paypal_order_id
            ));
            
            // Save additional meta
            $order->update_meta_data('_paypal_transaction_id', $transaction_id);
            $order->update_meta_data('_paypal_seller_protection', $seller_protection);
            $order->update_meta_data('_paypal_account_status', $acc_verified_status);
            $order->save();
        }
        
        // Mirror order to server
        $mirror_response = $api_handler->mirror_order_to_server($order, $paypal_order_id, $transaction_id);
        
        if ($server_id) {
            // Get the order total amount
            $order_amount = floatval($order->get_total());
            error_log('PayPal Proxy - Order amount to add to usage: ' . $order_amount);
            
            // Get server manager instance
            require_once WPPPC_PLUGIN_DIR . 'includes/class-server-manager.php';
            $server_manager = WPPPC_Server_Manager::get_instance();
            
            // Update usage with order amount
            $result = $server_manager->add_server_usage($server_id, $order_amount);
            error_log('PayPal Proxy - Result of add_server_usage: ' . ($result ? 'success' : 'failed'));
            
            error_log('PayPal Proxy - Added ' . $order_amount . ' to server usage for server ID ' . $server_id);
        } else {
            error_log('PayPal Proxy - No server_id found, cannot add usage');
        }
        
        // Empty the cart
        WC()->cart->empty_cart();
        
        // Return success with redirect URL
        wp_send_json_success(array(
            'redirect' => $order->get_checkout_order_received_url()
        ));
        
    } catch (Exception $e) {
        wpppc_log("Express Checkout: Error completing order: " . $e->getMessage());
        wp_send_json_error(array(
            'message' => $e->getMessage()
        ));
    }
    
    wp_die();
}
    
   public function ajax_fetch_paypal_order_details() {
   // check_ajax_referer('wpppc-express-nonce', 'nonce');
    
    $order_id = isset($_POST['order_id']) ? intval($_POST['order_id']) : 0;
    $paypal_order_id = isset($_POST['paypal_order_id']) ? sanitize_text_field($_POST['paypal_order_id']) : '';
    
    try {
        // Get order
        $order = wc_get_order($order_id);
        if (!$order) {
            throw new Exception(__('Order not found', 'woo-paypal-proxy-client'));
        }
        
        // Get server ID
        $server_id = get_post_meta($order->get_id(), '_wpppc_server_id', true);
        
        // Get server
        $server_manager = WPPPC_Server_Manager::get_instance();
        $server = $server_manager->get_server($server_id);
        
        if (!$server) {
            throw new Exception(__('PayPal server not found', 'woo-paypal-proxy-client'));
        }
        
        // Call the endpoint to get PayPal order details
        $timestamp = time();
        $hash_data = $timestamp . $paypal_order_id . $server->api_key;
        $hash = hash_hmac('sha256', $hash_data, $server->api_secret);
        
        $response = wp_remote_post(
            $server->url . '/wp-json/wppps/v1/get-paypal-order',
            array(
                'timeout' => 30,
                'headers' => array('Content-Type' => 'application/json'),
                'body' => json_encode(array(
                    'api_key' => $server->api_key,
                    'paypal_order_id' => $paypal_order_id,
                    'timestamp' => $timestamp,
                    'hash' => $hash
                ))
            )
        );
        
        // Get PayPal order details
        $body = json_decode(wp_remote_retrieve_body($response), true);
        $order_details = isset($body['order_details']) ? $body['order_details'] : null;
        
        if (!$order_details) {
            throw new Exception(__('No order details in response', 'woo-paypal-proxy-client'));
        }
        
        // Process shipping address first
        $shipping_address = array();
        if (!empty($order_details['purchase_units']) && is_array($order_details['purchase_units'])) {
            foreach ($order_details['purchase_units'] as $unit) {
                if (!empty($unit['shipping'])) {
                    // Get name
                    if (!empty($unit['shipping']['name'])) {
                        if (!empty($unit['shipping']['name']['full_name'])) {
                            $name_parts = explode(' ', $unit['shipping']['name']['full_name'], 2);
                            $shipping_address['first_name'] = $name_parts[0];
                            $shipping_address['last_name'] = isset($name_parts[1]) ? $name_parts[1] : '';
                        }
                    }
                    
                    // Get address
                    if (!empty($unit['shipping']['address'])) {
                        $address = $unit['shipping']['address'];
                        $shipping_address['address_1'] = isset($address['address_line_1']) ? $address['address_line_1'] : '';
                        $shipping_address['address_2'] = isset($address['address_line_2']) ? $address['address_line_2'] : '';
                        $shipping_address['city'] = isset($address['admin_area_2']) ? $address['admin_area_2'] : '';
                        $shipping_address['state'] = isset($address['admin_area_1']) ? $address['admin_area_1'] : '';
                        $shipping_address['postcode'] = isset($address['postal_code']) ? $address['postal_code'] : '';
                        $shipping_address['country'] = isset($address['country_code']) ? $address['country_code'] : '';
                    }
                    
                    // Set shipping address
                    if (!empty($shipping_address['first_name']) && !empty($shipping_address['address_1'])) {
                        $order->set_address($shipping_address, 'shipping');
                        
                        // IMPORTANT: For Express checkout, copy shipping to billing
                        $billing_address = $shipping_address;
                        
                        // Add email from payer if available
                        if (!empty($order_details['payer']['email_address'])) {
                            $billing_address['email'] = $order_details['payer']['email_address'];
                        }
                        
                        // Add phone if available from payer
                        if (!empty($order_details['payer']['phone']['phone_number']['national_number'])) {
                            $billing_address['phone'] = $order_details['payer']['phone']['phone_number']['national_number'];
                        }
                        
                        // Set billing address
                        $order->set_address($billing_address, 'billing');
                        
                        // Save the order
                        $order->save();
                        
                        wpppc_log("Express Checkout: Set shipping and billing addresses from PayPal");
                    }
                    
                    break; // We only need the first shipping address
                }
            }
        }
        
        // Return success
        wp_send_json_success(array(
            'message' => 'Order details retrieved and addresses updated',
            'has_billing' => !empty($billing_address),
            'has_shipping' => !empty($shipping_address)
        ));
        
    } catch (Exception $e) {
        wpppc_log("Express Checkout: Error fetching order details: " . $e->getMessage());
        wp_send_json_error(array(
            'message' => $e->getMessage()
        ));
    }
    
    wp_die();
}
}

// Initialize Express Checkout
add_action('init', function() {
    new WPPPC_Express_Checkout();
});